<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Space Taxi Retro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #000;
            margin: 0;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
        }
        canvas {
            image-rendering: pixelated;
            display: block;
            margin: 0 auto;
            background: #050505;
            touch-action: none;
        }
        .retro-border {
            border: 4px solid #444;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }
        .ui-panel {
            background: rgba(20, 20, 20, 0.85);
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">

    <div id="game-container" class="relative">
        <!-- UI Overlay -->
        <div id="ui" class="absolute top-0 left-0 w-full p-4 flex justify-between ui-panel text-xs md:text-sm z-10 select-none pointer-events-none">
            <div>
                CASH: $<span id="cash">0</span><br>
                FUEL: <span id="fuel-val">100</span>%
                <div class="w-24 h-2 bg-gray-800 mt-1 border border-gray-600">
                    <div id="fuel-bar" class="h-full bg-green-500" style="width: 100%"></div>
                </div>
            </div>
            <div class="text-center">
                <span id="message" class="text-yellow-400 font-bold uppercase">Ready for Duty!</span>
            </div>
            <div class="text-right">
                LEVEL: <span id="level-idx">1</span><br>
                GO TO: <span id="target" class="text-white">-</span>
            </div>
        </div>

        <!-- Start/Game Over Screens -->
        <div id="overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 z-20 text-white text-center p-6">
            <h1 class="text-4xl md:text-6xl font-bold mb-4 text-yellow-500 italic">SPACE TAXI</h1>
            <p id="overlay-msg" class="mb-8 text-sm md:text-base">Steuere dein Taxi mit den Pfeiltasten.<br>Landen vorsichtig auf den Plattformen!</p>
            <button id="start-btn" class="px-8 py-3 bg-yellow-600 hover:bg-yellow-500 text-black font-bold rounded-lg transition-transform active:scale-95 uppercase">Start Game</button>
        </div>

        <canvas id="gameCanvas" class="retro-border"></canvas>

        <!-- Touch Controls -->
        <div id="controls" class="absolute bottom-4 left-4 right-4 flex justify-between md:hidden z-10 pointer-events-none">
            <div class="flex gap-4 pointer-events-auto">
                <button id="btn-left" class="w-16 h-16 bg-white/20 rounded-full border-2 border-white/40 flex items-center justify-center text-3xl">←</button>
                <button id="btn-right" class="w-16 h-16 bg-white/20 rounded-full border-2 border-white/40 flex items-center justify-center text-3xl">→</button>
            </div>
            <div class="pointer-events-auto">
                <button id="btn-up" class="w-20 h-20 bg-yellow-500/40 rounded-full border-2 border-yellow-500/60 flex items-center justify-center text-4xl">↑</button>
            </div>
        </div>
    </div>

    <script>
        /** * SPACE TAXI - CORE LOGIC
         */

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('start-btn');
        const overlay = document.getElementById('overlay');
        const overlayMsg = document.getElementById('overlay-msg');
        
        // Game State
        let gameState = 'START'; // START, PLAYING, CRASHED, SUCCESS
        let cash = 0;
        let fuel = 100;
        let currentLevel = 0;
        let animationId;
        
        // Audio Context for Retro Beeps
        let audioCtx = null;
        function playSound(freq, duration, type = 'square', volume = 0.1) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(volume, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // Configuration
        const GRAVITY = 0.035;
        const THRUST_X = 0.08;
        const THRUST_Y = 0.12;
        const FRICTION = 0.98;
        const MAX_LANDING_VEL = 0.8;
        const MAX_LANDING_ANGLE = 0.2;

        const TAXI_WIDTH = 30;
        const TAXI_HEIGHT = 20;

        const taxi = {
            x: 100,
            y: 100,
            vx: 0,
            vy: 0,
            angle: 0,
            thrusting: { up: false, left: false, right: false },
            passenger: null,
            landedOn: null,
            reset() {
                this.x = 80;
                this.y = 80;
                this.vx = 0;
                this.vy = 0;
                this.angle = 0;
                this.passenger = null;
                this.landedOn = null;
            }
        };

        const levels = [
            {
                platforms: [
                    { x: 50, y: 350, w: 100, h: 15, id: 1 },
                    { x: 450, y: 150, w: 100, h: 15, id: 2 },
                    { x: 650, y: 400, w: 100, h: 15, id: 3 }
                ],
                walls: [
                    { x: 0, y: 0, w: 800, h: 20 }, // ceiling
                    { x: 0, y: 580, w: 800, h: 20 }, // floor
                    { x: 0, y: 0, w: 20, h: 600 },   // left
                    { x: 780, y: 0, w: 20, h: 600 }  // right
                ],
                passengerSpawn: { pId: 1, targetPId: 3 }
            },
            {
                platforms: [
                    { x: 100, y: 150, w: 100, h: 15, id: 1 },
                    { x: 100, y: 450, w: 100, h: 15, id: 2 },
                    { x: 600, y: 150, w: 100, h: 15, id: 3 },
                    { x: 600, y: 450, w: 100, h: 15, id: 4 }
                ],
                walls: [
                    { x: 0, y: 0, w: 800, h: 20 },
                    { x: 0, y: 580, w: 800, h: 20 },
                    { x: 0, y: 0, w: 20, h: 600 },
                    { x: 780, y: 0, w: 20, h: 600 },
                    { x: 350, y: 200, w: 100, h: 200 } // Middle Obstacle
                ],
                passengerSpawn: { pId: 2, targetPId: 3 }
            }
        ];

        let passenger = {
            active: false,
            platformId: null,
            targetPlatformId: null,
            state: 'WAITING', // WAITING, IN_TAXI, ARRIVED
            x: 0,
            y: 0
        };

        function initPassenger() {
            const level = levels[currentLevel];
            const p = level.platforms.find(pl => pl.id === level.passengerSpawn.pId);
            passenger.active = true;
            passenger.platformId = p.id;
            passenger.targetPlatformId = level.passengerSpawn.targetPId;
            passenger.state = 'WAITING';
            passenger.x = p.x + p.w / 2;
            passenger.y = p.y - 5;
            document.getElementById('target').innerText = "Platform " + passenger.targetPlatformId;
            document.getElementById('message').innerText = "Pick up at P" + passenger.platformId;
        }

        function resize() {
            const container = document.getElementById('game-container');
            const w = Math.min(window.innerWidth - 40, 800);
            const h = Math.min(window.innerHeight - 200, 600);
            canvas.width = 800; // Fixed internal resolution
            canvas.height = 600;
            canvas.style.width = w + 'px';
            canvas.style.height = (w * 0.75) + 'px';
        }

        window.addEventListener('resize', resize);
        resize();

        // Input Handling
        const keys = {};
        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        // Touch buttons
        const btnUp = document.getElementById('btn-up');
        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');

        function updateInput() {
            taxi.thrusting.up = keys['ArrowUp'] || keys['KeyW'] || btnUp.isDown;
            taxi.thrusting.left = keys['ArrowLeft'] || keys['KeyA'] || btnLeft.isDown;
            taxi.thrusting.right = keys['ArrowRight'] || keys['KeyD'] || btnRight.isDown;
        }

        [btnUp, btnLeft, btnRight].forEach(btn => {
            btn.addEventListener('touchstart', (e) => { e.preventDefault(); btn.isDown = true; });
            btn.addEventListener('touchend', (e) => { e.preventDefault(); btn.isDown = false; });
        });

        function checkCollision(obj, wall) {
            return obj.x - TAXI_WIDTH / 2 < wall.x + wall.w &&
                   obj.x + TAXI_WIDTH / 2 > wall.x &&
                   obj.y - TAXI_HEIGHT / 2 < wall.y + wall.h &&
                   obj.y + TAXI_HEIGHT / 2 > wall.y;
        }

        function gameLoop() {
            if (gameState !== 'PLAYING') return;

            updateInput();
            
            // Physics
            if (taxi.thrusting.up && fuel > 0) {
                taxi.vy -= THRUST_Y;
                fuel -= 0.1;
                if (Math.random() > 0.8) playSound(100 + Math.random() * 50, 0.05, 'sawtooth', 0.05);
            }
            if (taxi.thrusting.left && fuel > 0) {
                taxi.vx -= THRUST_X;
                fuel -= 0.05;
                taxi.angle = -0.15;
            } else if (taxi.thrusting.right && fuel > 0) {
                taxi.vx += THRUST_X;
                fuel -= 0.05;
                taxi.angle = 0.15;
            } else {
                taxi.angle *= 0.9;
            }

            taxi.vy += GRAVITY;
            taxi.vx *= FRICTION;
            taxi.vy *= FRICTION;

            taxi.x += taxi.vx;
            taxi.y += taxi.vy;

            // Fuel UI
            document.getElementById('fuel-val').innerText = Math.floor(fuel);
            document.getElementById('fuel-bar').style.width = fuel + '%';
            if (fuel < 20) document.getElementById('fuel-bar').className = 'h-full bg-red-500';
            else if (fuel < 50) document.getElementById('fuel-bar').className = 'h-full bg-yellow-500';

            // Wall Collisions
            const level = levels[currentLevel];
            for (let wall of level.walls) {
                if (checkCollision(taxi, wall)) {
                    crash();
                }
            }

            // Platform Collisions
            let landing = false;
            for (let plat of level.platforms) {
                if (checkCollision(taxi, plat)) {
                    // Check if landing or crashing
                    if (taxi.vy > MAX_LANDING_VEL || Math.abs(taxi.vx) > MAX_LANDING_VEL || Math.abs(taxi.angle) > MAX_LANDING_ANGLE) {
                        crash();
                    } else {
                        // Soft touch - Snap to platform
                        taxi.y = plat.y - TAXI_HEIGHT / 2;
                        taxi.vy = 0;
                        taxi.vx = 0;
                        taxi.angle = 0;
                        landing = true;
                        taxi.landedOn = plat.id;
                    }
                }
            }
            if (!landing) taxi.landedOn = null;

            // Passenger Logic
            if (passenger.state === 'WAITING' && taxi.landedOn === passenger.platformId) {
                passenger.state = 'IN_TAXI';
                playSound(600, 0.2, 'sine');
                document.getElementById('message').innerText = "Go to P" + passenger.targetPlatformId;
                document.getElementById('target').style.color = "#0f0";
            } else if (passenger.state === 'IN_TAXI' && taxi.landedOn === passenger.targetPlatformId) {
                passenger.state = 'ARRIVED';
                cash += 50;
                document.getElementById('cash').innerText = cash;
                document.getElementById('message').innerText = "Thank you! Next Level...";
                playSound(800, 0.3, 'sine');
                setTimeout(nextLevel, 1500);
            }

            draw();
            animationId = requestAnimationFrame(gameLoop);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const level = levels[currentLevel];

            // Draw Walls
            ctx.fillStyle = '#334';
            level.walls.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h));

            // Draw Platforms
            level.platforms.forEach(p => {
                ctx.fillStyle = '#667';
                ctx.fillRect(p.x, p.y, p.w, p.h);
                ctx.fillStyle = '#fff';
                ctx.font = '10px Arial';
                ctx.fillText('P' + p.id, p.x + 5, p.y + 12);
            });

            // Draw Passenger
            if (passenger.active && passenger.state === 'WAITING') {
                ctx.fillStyle = '#f0f';
                ctx.beginPath();
                ctx.arc(passenger.x, passenger.y - 10, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillRect(passenger.x - 3, passenger.y - 10, 6, 10);
                
                // Bubble
                ctx.fillStyle = "white";
                ctx.font = "10px monospace";
                ctx.fillText("TAXI!", passenger.x - 15, passenger.y - 25);
            }

            // Draw Taxi
            ctx.save();
            ctx.translate(taxi.x, taxi.y);
            ctx.rotate(taxi.angle);

            // Body
            ctx.fillStyle = '#ff0';
            ctx.fillRect(-TAXI_WIDTH / 2, -TAXI_HEIGHT / 2, TAXI_WIDTH, TAXI_HEIGHT - 5);
            
            // Cockpit
            ctx.fillStyle = '#0cf';
            ctx.fillRect(0, -TAXI_HEIGHT / 2 + 2, TAXI_WIDTH / 2 - 2, 8);

            // Wheels/Pads
            ctx.fillStyle = '#333';
            ctx.fillRect(-TAXI_WIDTH / 2 + 2, TAXI_HEIGHT / 2 - 5, 6, 5);
            ctx.fillRect(TAXI_WIDTH / 2 - 8, TAXI_HEIGHT / 2 - 5, 6, 5);

            // Thrust Fire
            if (taxi.thrusting.up && fuel > 0) {
                ctx.fillStyle = Math.random() > 0.5 ? '#f90' : '#f00';
                ctx.fillRect(-5, TAXI_HEIGHT / 2, 10, 10 + Math.random() * 10);
            }

            ctx.restore();
        }

        function crash() {
            gameState = 'CRASHED';
            playSound(100, 0.5, 'sawtooth', 0.2);
            playSound(50, 0.5, 'square', 0.2);
            document.getElementById('message').innerText = "CRASHED!";
            overlay.classList.remove('hidden');
            overlayMsg.innerHTML = `<span class="text-red-500 text-3xl font-bold">GAME OVER</span><br>Vorsichtiger fliegen! Cash: $${cash}`;
            startBtn.innerText = "Try Again";
            cancelAnimationFrame(animationId);
        }

        function nextLevel() {
            currentLevel++;
            if (currentLevel >= levels.length) {
                gameState = 'SUCCESS';
                overlay.classList.remove('hidden');
                overlayMsg.innerHTML = `<span class="text-green-500 text-3xl font-bold">MISSION COMPLETE</span><br>Du bist der beste Pilot! Total Cash: $${cash}`;
                startBtn.innerText = "Restart Game";
                currentLevel = 0;
                cash = 0;
            } else {
                initLevel();
            }
        }

        function initLevel() {
            taxi.reset();
            fuel = 100;
            initPassenger();
            document.getElementById('level-idx').innerText = currentLevel + 1;
            document.getElementById('cash').innerText = cash;
        }

        startBtn.onclick = () => {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            overlay.classList.add('hidden');
            gameState = 'PLAYING';
            if (currentLevel === 0) cash = 0;
            initLevel();
            gameLoop();
        };

        // Initial Draw
        draw();
    </script>
</body>
</html>